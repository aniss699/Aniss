ğŸ› ï¸ PROMPT REPLIT â€” RÃ©parer lâ€™ajout de mission (boutons/route/validation) + IA utile pendant la crÃ©ation (rÃ©Ã©criture, prix/dÃ©lais, questions, â€œappliquerâ€ en 1 clic)

Tu es un assistant IA fullâ€‘stack.
Dans mon repo, corrige toutes les pages et actions qui ajoutent une mission/projet (crÃ©ation via boutons/ formulaires/UI) et rends lâ€™IA vraiment utile au moment de crÃ©er la mission : rÃ©Ã©criture/standardisation de lâ€™annonce, suggestions prix/dÃ©lais, questions manquantes, aperÃ§u LOC, bouton â€œAppliquer les suggestionsâ€.
Livre code, migrations, tests, et doc. (Ignore les sujets Preview.)

â¸»

0) Cible & vocabulaire
	â€¢	â€œMissionâ€ = enregistrement principal (table Project ou Mission).
	â€¢	Front : pages SSR existantes (templates) et/ou composants client lÃ©gers (fetch).
	â€¢	API : Fastify/Express (TypeScript).

â¸»

1) Corriger les pages dâ€™ajout de mission (UI + routes)

A. Pages Ã  (re)crÃ©er/fiabiliser
	â€¢	GET /missions/new (ou /projects/new) : formulaire de crÃ©ation.
	â€¢	Champs : title, description, category, budget_min, budget_max, deadline_ts?, geo_required?, onsite_radius_km?.
	â€¢	Boutons :
	1.	CrÃ©er la mission (soumet vers POST)
	2.	AmÃ©liorer avec lâ€™IA (AJAX â†’ /ai/missions/suggest), affiche un panneau latÃ©ral avec propositions.
	3.	Appliquer les suggestions (patch des champs du formulaire depuis la suggestion IA).
	â€¢	GET /missions/:id : dÃ©tail mission (affiche ce qui a Ã©tÃ© appliquÃ©).
	â€¢	GET /missions/:id/edit : Ã©dition (repropose le panneau IA).

B. Actions/boutons qui Ã©chouaient
	â€¢	RÃ©parer tous les boutons â€œCrÃ©er/Publier/Enregistrerâ€ qui renvoient 404/500 :
	â€¢	VÃ©rifier les form action + method + name/id des inputs.
	â€¢	Si SPA partielle : vÃ©rifier les URLs de fetch() et les headers (Content-Type: application/json).
	â€¢	Si CSRF en place : inclure le token (meta + header).
	â€¢	Ajouter un champ cachÃ© Idempotency-Key (uuid v4) cÃ´tÃ© formulaire.

C. UX erreurs
	â€¢	En cas dâ€™erreur, rester sur la page et afficher :
	â€¢	bandeau global (message FR clair),
	â€¢	erreurs field-level (sous le champ),
	â€¢	hint (â€œbudget_min doit Ãªtre â‰¤ budget_maxâ€).
	â€¢	Ne jamais rendre un 500 brut Ã  lâ€™utilisateur : log interne + message FR.

â¸»

2) API â€” POST/PUT robustes (crÃ©ation/Ã©dition de mission)

A. POST /missions
	â€¢	Validation Zod (alignÃ©e Prisma) :

title: string(min 3)
description: string(min 10)
category: enum(Category)
budget_min: number â‰¥ 1000
budget_max: number â‰¥ budget_min
deadline_ts?: ISO future
geo_required?: boolean
onsite_radius_km?: number â‰¥ 0 (si geo_required)


	â€¢	Transaction DB (Prisma) : crÃ©er Mission + EventLog.
	â€¢	Idempotence (header ou champ cachÃ© Idempotency-Key) : si rejouÃ© <15 min â†’ renvoyer la mÃªme ressource.
	â€¢	RÃ©ponse : 201 {id, status:'DRAFT'|'PUBLISHED'} + validation:{warnings[], infos[]}.

B. PUT /missions/:id
	â€¢	MÃªme Zod + transaction + idempotence (clÃ© diffÃ©rente).

C. Erreurs uniformes
	â€¢	422 {code:'VALIDATION_ERROR', field, message, hint}
	â€¢	409 idempotence dÃ©jÃ  utilisÃ©e
	â€¢	500 {code:'INTERNAL_ERROR', trace_id} (log pino)

â¸»

3) IA pendant la crÃ©ation (utile et actionnable)

A. Endpoint suggestion : POST /ai/missions/suggest
	â€¢	EntrÃ©e : le brouillon du formulaire { title, description, category?, budget_min?, budget_max?, deadline_ts? }.
	â€¢	Traitements (offline, pas dâ€™API payante) :
	â€¢	RÃ©Ã©criture/standardisation : title_suggest, summary_suggest, acceptance_criteria[].
	â€¢	Taxonomie & skills : category_std, sub_category_std, skills_std[], tags_std[].
	â€¢	QualitÃ© du brief : brief_quality_score, richness_score, missing_info[] (questions concrÃ¨tes).
	â€¢	Prix/dÃ©lais : price_suggested_min/med/max, delay_suggested_days, rationale.
	â€¢	LOC (approx) : loc_base + uplift_reco {new_budget, new_delay, delta_loc}.
	â€¢	Sortie :

{
  "suggestion": {
    "title": "...",
    "summary": "...",
    "acceptance_criteria": ["..."],
    "category_std": "...",
    "sub_category_std": "...",
    "skills_std": ["..."],
    "tags_std": ["..."],
    "brief_quality_score": 0.78,
    "richness_score": 0.72,
    "missing_info": [{"id":"surface_m2","q":"Quelle surface ?"}],
    "price_suggested_min": 65000,
    "price_suggested_med": 78000,
    "price_suggested_max": 98000,
    "delay_suggested_days": 10,
    "loc_base": 0.61,
    "loc_uplift_reco": {"new_budget": 82000, "new_delay": 12, "delta_loc": +0.08},
    "reasons": ["Brief peu prÃ©cis â†’ proposer critÃ¨res SMART", "Budget mÃ©dian basÃ© sur PRM travaux intÃ©rieurs"]
  }
}



B. Endpoint application (prÃ©â€‘crÃ©ation) : POST /ai/missions/apply-suggestion
	â€¢	EntrÃ©e : suggestion retournÃ©e + apply params {budget:'min'|'med'|'max', delay:boolean, text:boolean}.
	â€¢	Sortie : payload â€œpatchâ€ Ã  injecter dans le formulaire (front remplit les champs automatiquement).

C. Enregistrement de la standardisation si lâ€™utilisateur soumet
	â€¢	Ã€ la crÃ©ation rÃ©ussie (POST /missions) : stocker ProjectStandardization (liÃ©e Ã  la mission) avec la suggestion retenue (si utilisÃ©e).

â¸»

4) Front : panneau IA rÃ©actif (lÃ©ger)
	â€¢	Dans /missions/new :
	â€¢	Bouton â€œAmÃ©liorer avec lâ€™IAâ€ â†’ fetch('/ai/missions/suggest', {body: JSON du formulaire}).
	â€¢	Afficher cÃ´te Ã  cÃ´te :
	â€¢	Colonne gauche : Saisie utilisateur (Ã©ditable).
	â€¢	Colonne droite : Proposition IA (readonly) + Appliquer cases :
	â€¢	â˜ Titre + rÃ©sumÃ©
	â€¢	â˜ Prix mÃ©dian (radio min/med/max)
	â€¢	â˜ DÃ©lais
	â€¢	Liste Questions manquantes (inputs lÃ©gers).
	â€¢	Bouton â€œAppliquer les suggestionsâ€ â†’ remplit les champs du formulaire (sans submit).
	â€¢	Lorsque lâ€™utilisateur soumet, inclure les rÃ©ponses aux questions manquantes si fournies.
	â€¢	Gestion erreurs rÃ©seau : toast FR clair, pas de crash.

â¸»

5) ModÃ¨le & migration DB
	â€¢	Ajouter table ProjectStandardization si absente :
mission_id FK, title_std, summary_std, acceptance_criteria text[],
category_std, sub_category_std, tags_std string[], skills_std string[],
brief_quality_score float, richness_score float, missing_info jsonb[],
price_suggested_min/med/max int, delay_suggested_days int,
loc_base float, loc_uplift_reco jsonb, rewrite_version string, timestamps.
	â€¢	Index GIN sur skills_std, tags_std.

â¸»

6) IntÃ©gration scoring (optionnel mais recommandÃ©)
	â€¢	Au moment du preview (aprÃ¨s crÃ©ation), exposer un endpoint :
	â€¢	GET /ai/missions/:id/preview-scoring â†’ GlobalScore breakdown avec bonus :

QualityScore' = QualityScore * (1 + 0.20*(brief_quality_score - 0.5))
FitScore'     = FitScore     * (1 + 0.15*(richness_score      - 0.5))
if missing_info_count > 0: Risk += 0.05; TimeScore -= 0.03



â¸»

7) Tests (doivent Ã©chouer avant fix, puis passer)

E2E (supertest)
	1.	Form page : GET /missions/new â†’ 200 et prÃ©sence des champs + bouton â€œAmÃ©liorer avec lâ€™IAâ€.
	2.	Suggestion IA : POST /ai/missions/suggest avec un brief simple â†’ 200 + champs attendus (price_suggested_*, missing_info).
	3.	Appliquer : POST /ai/missions/apply-suggestion â†’ renvoie patch cohÃ©rent (titre/summary, budget/dÃ©lais).
	4.	CrÃ©ation mission : POST /missions â†’ 201 + mission crÃ©Ã©e, ProjectStandardization persistÃ©e si suggestion appliquÃ©e.
	5.	Rouge : budget inversÃ© â†’ 422 avec field:'budget_min'.
	6.	Idempotence : POST /missions avec mÃªme Idempotency-Key â†’ mÃªme id.

Unit (Vitest/Jest)
	â€¢	Valideurs Zod (success/fail).
	â€¢	Helpers idempotence (snapshot).
	â€¢	Mapper â€œapply suggestionâ€ (front utilitaire).

â¸»

8) Diagnostics
	â€¢	GET /admin/diagnostics : { routes_ok:true, forms_ok:true, db_ok, migrations_applied[], last_5_errors[] }
	â€¢	GET /logs/errors?since=... (dev) : 50 derniÃ¨res erreurs.

â¸»

9) README (FR)
	â€¢	â€œCrÃ©er une missionâ€ pas Ã  pas (avec IA).
	â€¢	Exemples cURL : crÃ©ation OK, KO, idempotence, suggestion IA.

â¸»

10) cURL de vÃ©rification rapide

# 1) Suggestion IA Ã  partir dâ€™un brouillon
curl -X POST http://localhost:3000/ai/missions/suggest \
  -H "Content-Type: application/json" \
  -d '{"title":"Peinture salon","description":"Peindre murs 40 mÂ², 2 couches satin","category":"travaux","budget_min":60000,"budget_max":120000}'

# 2) Appliquer la suggestion (budget mÃ©dian + dÃ©lais + texte)
curl -X POST http://localhost:3000/ai/missions/apply-suggestion \
  -H "Content-Type: application/json" \
  -d '{"suggestion":{ ... }, "apply":{"budget":"med","delay":true,"text":true}}'

# 3) CrÃ©ation mission (avec idempotence)
curl -X POST http://localhost:3000/missions \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: mission-abc-001" \
  -d '{"title":"Peinture salon (amÃ©liorÃ©)","description":"...","category":"travaux","budget_min":70000,"budget_max":120000,"deadline_ts":"2025-10-01"}'

# 4) Rejeu idempotent
curl -X POST http://localhost:3000/missions \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: mission-abc-001" \
  -d '{"title":"Peinture salon (amÃ©liorÃ©)","description":"...","category":"travaux","budget_min":70000,"budget_max":120000,"deadline_ts":"2025-10-01"}'


â¸»

ImplÃ©mente exactement ce qui prÃ©cÃ¨de :
	â€¢	Boutons de crÃ©ation fonctionnels (plus dâ€™erreur),
	â€¢	Panneau â€œAmÃ©liorer avec lâ€™IAâ€ qui rÃ©Ã©crit, structure, propose prix/dÃ©lais, pose des questions,
	â€¢	Appliquer en 1 clic dans le formulaire,
	â€¢	CrÃ©ation qui persiste la standardisation si utilisÃ©e,
	â€¢	Tests e2e verts, diagnostics disponibles, doc Ã  jour.